<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="robots" content="noindex, nofollow, noarchive" />
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>Obsidienne - Automate downloads</title>
    <link rel="stylesheet" href="/assets/style.css">
    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <link rel="alternate" type="application/rss+xml" title="Posts" href="/rss.xml" />
</head>

<body>
<main>
<header>
<a href="/">obsidienne</a>
</header>

<article>

<header>
<h1>Automate downloads</h1>
<time>2020-09-04</time>
</header>

<nav class="toc">
<ul>
<li><a href="#dotxpathdl"><span class="toc-section-number">1</span> Dotxpathdl</a></li>
<li><a href="#browser-web-console"><span class="toc-section-number">2</span> Browser Web Console</a></li>
<li><a href="#userscripts"><span class="toc-section-number">3</span> Userscripts</a></li>
<li><a href="#selenium"><span class="toc-section-number">4</span> Selenium</a></li>
<li><a href="#post-processing-with-bash"><span class="toc-section-number">5</span> Post-processing with Bash</a></li>
</ul>
</nav>

<h1 data-number="1" id="dotxpathdl"><span class="header-section-number">1</span> Dotxpathdl</h1>
<p>I wrote dotxpathdl first as a <a href="https://gitlab.com/Obsidienne/dotfiles/-/blob/163b023baec5613d1e5f64a58dcf6de66f000d98/user/bin/dotxpathdl">cli tool</a> and then as a <a href="https://gitlab.com/Obsidienne/dotfiles/-/blob/a86e690017f57eb7a3b1e6b7f70e4005efc4e183/user/lib/python/dotxpathdl.py">python module</a> to download files on a sequence of pages (e.g. webcomics) with the help of XPath expressions. The module navigates to <code>start_url</code>, retrieves file URLs with <code>elem_xpath</code>, downloads them, goes to the next page by retrieving its url with <code>next_xpath</code>, and repeats the previous steps until there is no next page.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotxpathdl <span class="im">import</span> Downloader <span class="im">as</span> Xpdl</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">&#39;https://www.webtoons.com/en/supernatural/muted/episode-1/viewer?title_no=1566&amp;episode_no=1&#39;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Fails: download &#39;bg_transparency.png&#39; (1x1 transparent png image) 80</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># times because the src attribute was not set due to JavaScript not being</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># interpreted.</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>Xpdl(url, <span class="st">&#39;//div[@id=&quot;_imageList&quot;]/img/@src&#39;</span>).start()</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Fails: download &quot;Referral Denied&quot; error webpage 80 times due to missing</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># referer HTTP header.</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>Xpdl(url, <span class="st">&#39;//div[@id=&quot;_imageList&quot;]/img/@data-url&#39;</span>).start()</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Works: download works after adding the expected referer to the HTTP request</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># header.</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>Xpdl(</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    start_url  <span class="op">=</span> url,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    elem_xpath <span class="op">=</span> <span class="st">&#39;//div[@id=&quot;_imageList&quot;]/img/@data-url&#39;</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    next_xpath <span class="op">=</span> <span class="st">&#39;//a[contains(@class, &quot;pg_next _nextEpisode&quot;)]/@href&#39;</span>,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    headers    <span class="op">=</span> { <span class="st">&#39;referer&#39;</span>: <span class="st">&#39;https://www.webtoons.com/&#39;</span> },</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>).start()</span></code></pre></div>
<h1 data-number="2" id="browser-web-console"><span class="header-section-number">2</span> Browser Web Console</h1>
<p>The script above can’t handle websites loading their content via JavaScript. We can solve this problem by automating downloads in the browser. It will also be easier to handle scenarios where authentication is needed. First of all I created a new Firefox profile (<code>firefox --ProfileManager</code>) to avoid modifying my main profile preferences.</p>
<p>We would like to download a file from a link on a page by using JavaScript and the browser’s web console (F12).</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// example: https://www.archlinux.org/packages/core/x86_64/bash/</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#actionlist li:last-child a&#39;</span>)<span class="op">.</span><span class="fu">click</span>()</span></code></pre></div>
<p>It works with this specific example, but there are two problems with the above code. First, the browser might try to preview the file instead of downloading it (e.g. images, PDFs). Second, it displays the save dialog instead of starting the download automatically which is a problem if we need to download a large number of files.</p>
<p>We can solve the first problem by adding the <code>download</code> attribute to the link. But it will only work if the file is stored on the same domain as the webpage we are currently viewing.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// example: https://www.gnu.org/</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> img <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;img&#39;</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> a <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;a&#39;</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>a<span class="op">.</span><span class="at">href</span> <span class="op">=</span> img<span class="op">.</span><span class="at">src</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>a<span class="op">.</span><span class="at">download</span> <span class="op">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>a<span class="op">.</span><span class="fu">click</span>()</span></code></pre></div>
<p>As mentioned above, the <code>download</code> attribute doesn’t work for cross origin sites (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=874009">bugzilla</a>). To bypass this restriction we can fetch the resource and create a link to the URL of the retrieved blob.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Example: https://www.webtoons.com/en/supernatural/muted/episode-1/viewer?title_no=1566&amp;episode_no=1</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> img <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#_imageList img&#39;</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">fetch</span>(img<span class="op">.</span><span class="at">src</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">then</span>(response <span class="kw">=&gt;</span> response<span class="op">.</span><span class="fu">blob</span>())</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">then</span>(blob <span class="kw">=&gt;</span> {</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> a <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;a&#39;</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        a<span class="op">.</span><span class="at">href</span> <span class="op">=</span> URL<span class="op">.</span><span class="fu">createObjectURL</span>(blob)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        a<span class="op">.</span><span class="at">download</span> <span class="op">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        a<span class="op">.</span><span class="fu">click</span>()</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    })</span></code></pre></div>
<p>It works, but now we would like to download all the files from a page without displaying the save dialog. The quickest and easiest way is probably to add the MIME types we would like to download automatically to Firefox preferences. You can set them in <code>about:preferences</code> (Action: Save File), but you need to have encountered the type at least once for it to appear in the list. These settings are saved in your Firefox profile directory in <code>handlers.json</code>. You can also set <code>browser.helperApps.neverAsk.saveToDisk</code> in <code>about:config</code> to a comma-separated list of MIME types (e.g. <code>image/jpeg,image/png</code>) to achieve the same result.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Example: https://www.webtoons.com/en/supernatural/muted/episode-1/viewer?title_no=1566&amp;episode_no=1</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;#_imageList img&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>((img<span class="op">,</span> i) <span class="kw">=&gt;</span> {</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fetch</span>(img<span class="op">.</span><span class="at">src</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">then</span>(response <span class="kw">=&gt;</span> response<span class="op">.</span><span class="fu">blob</span>())</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">then</span>(blob <span class="kw">=&gt;</span> {</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> a <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;a&#39;</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>            a<span class="op">.</span><span class="at">href</span> <span class="op">=</span> URL<span class="op">.</span><span class="fu">createObjectURL</span>(blob)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> path <span class="op">=</span> <span class="kw">new</span> <span class="fu">URL</span>(img<span class="op">.</span><span class="at">src</span>)<span class="op">.</span><span class="at">pathname</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>            path <span class="op">=</span> path<span class="op">.</span><span class="fu">substring</span>(path<span class="op">.</span><span class="fu">lastIndexOf</span>(<span class="st">&#39;/&#39;</span>) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>            a<span class="op">.</span><span class="at">download</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>i<span class="op">.</span><span class="fu">toString</span>()<span class="op">.</span><span class="fu">padStart</span>(<span class="dv">3</span><span class="op">,</span> <span class="st">&#39;0&#39;</span>)<span class="sc">}</span><span class="vs">_</span><span class="sc">${</span>path<span class="sc">}</span><span class="vs">`</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>            a<span class="op">.</span><span class="fu">click</span>()</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>We now know how to automate downloads on one page, but how do we handle a sequence of pages or more complex scenarios?</p>
<h1 data-number="3" id="userscripts"><span class="header-section-number">3</span> Userscripts</h1>
<p>We can use an extension to write and execute userscripts to scrape multiple pages (<a href="https://addons.mozilla.org/en-US/firefox/addon/greasemonkey/">Greasemonkey</a> or <a href="https://addons.mozilla.org/en-US/firefox/addon/violentmonkey/">Violentmonkey</a>).</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ==UserScript==</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">// @name Scrape webtoon</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">// @match *://www.webtoons.com/*/viewer*#monkey</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">// ==/UserScript==</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Example: https://www.webtoons.com/en/supernatural/muted/episode-1/viewer?title_no=1566&amp;episode_no=1#monkey</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="bu">window</span><span class="op">.</span><span class="at">ulocation</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">URL</span>(<span class="bu">window</span><span class="op">.</span><span class="at">location</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> epi <span class="op">=</span> ulocation<span class="op">.</span><span class="at">searchParams</span><span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;episode_no&#39;</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>epi <span class="op">=</span> epi<span class="op">.</span><span class="fu">toString</span>()<span class="op">.</span><span class="fu">padStart</span>(<span class="dv">3</span><span class="op">,</span> <span class="st">&#39;0&#39;</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> promises <span class="op">=</span> []</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;#_imageList img&#39;</span>)<span class="op">.</span><span class="fu">forEach</span>((img<span class="op">,</span> imgi) <span class="kw">=&gt;</span> {</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> p <span class="op">=</span> <span class="fu">fetch</span>(img<span class="op">.</span><span class="at">src</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">then</span>(response <span class="kw">=&gt;</span> response<span class="op">.</span><span class="fu">blob</span>())</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">then</span>(blob <span class="kw">=&gt;</span> {</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> a <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;a&#39;</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>            a<span class="op">.</span><span class="at">href</span> <span class="op">=</span> URL<span class="op">.</span><span class="fu">createObjectURL</span>(blob)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>            imgi <span class="op">=</span> imgi<span class="op">.</span><span class="fu">toString</span>()<span class="op">.</span><span class="fu">padStart</span>(<span class="dv">3</span><span class="op">,</span> <span class="st">&#39;0&#39;</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> path <span class="op">=</span> <span class="kw">new</span> <span class="fu">URL</span>(img<span class="op">.</span><span class="at">src</span>)<span class="op">.</span><span class="at">pathname</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>            path <span class="op">=</span> path<span class="op">.</span><span class="fu">substring</span>(path<span class="op">.</span><span class="fu">lastIndexOf</span>(<span class="st">&#39;/&#39;</span>) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>            a<span class="op">.</span><span class="at">download</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>epi<span class="sc">}</span><span class="vs">_</span><span class="sc">${</span>imgi<span class="sc">}</span><span class="vs">_</span><span class="sc">${</span>path<span class="sc">}</span><span class="vs">`</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>            a<span class="op">.</span><span class="fu">click</span>()</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    promises<span class="op">.</span><span class="fu">push</span>(p)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>(promises)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">then</span>(_ <span class="kw">=&gt;</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span> <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;a.pg_next&#39;</span>)<span class="op">.</span><span class="at">href</span> <span class="op">+</span> <span class="st">&#39;#monkey&#39;</span>)</span></code></pre></div>
<p>The <code>@match</code> metadata key describes which pages the script should be executed on. The script will only execute on webtoon comic pages and only if the <code>#monkey</code> anchor is added at the end of the URL. By adding the anchor rule, we can control when we want to start the download without interfering with normal web browsing.</p>
<p>Once all the image fetches have been resolved, we retrieve the next page URL, append the <code>#monkey</code> anchor to it and redirect the browser to it. The userscript then executes again on the new page because it also matches the <code>@match</code> rule of the script.</p>
<p>You might also want to add a delay between your requests to avoid overloading the web server and/or getting your IP blocked. The example below waits 5 seconds (arbitrarily) before redirecting to the next page.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>(promises)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">then</span>(_ <span class="kw">=&gt;</span> <span class="kw">new</span> <span class="bu">Promise</span>(resolve <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(resolve<span class="op">,</span> <span class="dv">5000</span>)))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">then</span>(_ <span class="kw">=&gt;</span> <span class="bu">window</span><span class="op">.</span><span class="at">location</span> <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;a.pg_next&#39;</span>)<span class="op">.</span><span class="at">href</span> <span class="op">+</span> <span class="st">&#39;#monkey&#39;</span>)</span></code></pre></div>
<p><strong>Note</strong>: I didn’t have any useful examples to demonstrate its use but you might need <a href="https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver">MutationObserver</a> to wait for changes to the DOM tree.</p>
<h1 data-number="4" id="selenium"><span class="header-section-number">4</span> Selenium</h1>
<p>Selenium is a browser automation tool (e.g. for web applications testing purposes). We can use it to automate downloads. I’m using the <a href="https://archlinux.org/packages/community/x86_64/python-selenium/">python binding</a> of selenium with <a href="https://archlinux.org/packages/community/x86_64/geckodriver/">geckodriver</a>. <a href="https://gitlab.com/Obsidienne/codeexperiments/-/blob/285eff138b78013f2b817e8d01307b3b61fabaca/Snippets/SeleniumScraping.py">This example</a> creates a firefox profile with <code>browser.helperApps.neverAsk.saveToDisk</code> set and launches the browser. The script first bypasses webtoons’ age gate by filling the form and then downloads the webcomic using code similar to the one in the previous section.</p>
<h1 data-number="5" id="post-processing-with-bash"><span class="header-section-number">5</span> Post-processing with Bash</h1>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># move each episode in its own subdirectory</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> <span class="pp">*</span>_<span class="pp">*</span>_<span class="pp">*</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">episode</span><span class="op">=</span><span class="st">&quot;e</span><span class="va">${f</span><span class="op">%%</span>_<span class="pp">*</span><span class="va">}</span><span class="st">&quot;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mkdir</span> <span class="at">-p</span> <span class="st">&quot;</span><span class="va">$episode</span><span class="st">&quot;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mv</span> <span class="st">&quot;</span><span class="va">$f</span><span class="st">&quot;</span> <span class="st">&quot;</span><span class="va">$episode</span><span class="st">&quot;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># create one cbz file per webtoon episode</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># note: apack is provided by the atool package in most linux distributions</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> e<span class="pp">*</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">apack</span> <span class="at">-F</span> zip <span class="st">&quot;</span><span class="va">$d</span><span class="st">.cbz&quot;</span> <span class="st">&quot;</span><span class="va">$d</span><span class="st">&quot;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>

</article>

</main>
</body>

</html>
