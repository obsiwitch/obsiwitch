<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="robots" content="noindex, nofollow, noarchive" />
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>Obsidienne - Fuzzy bash completion</title>
    <link rel="stylesheet" href="/assets/style.css">
    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <link rel="alternate" type="application/rss+xml" title="Posts" href="/rss.xml" />
</head>

<body>
<main>
<header>
<a href="/">obsidienne</a>
</header>

<article>

<header>
<h1>Fuzzy bash completion</h1>
<time>2019-06-02</time>
</header>

<nav>
<ul>
<li><a href="#introduction"><span class="toc-section-number">1</span> Introduction</a></li>
<li><a href="#fuzzy-path-completion-2019-06-02"><span class="toc-section-number">2</span> Fuzzy path completion (2019-06-02)</a></li>
<li><a href="#fuzzy-path-selection-on-keybinding-2019-07-23"><span class="toc-section-number">3</span> Fuzzy path selection on keybinding (2019-07-23)</a></li>
</ul>
</nav>

<h1 data-number="1" id="introduction"><span class="header-section-number">1</span> Introduction</h1>
<p><a href="https://github.com/junegunn/fzf">Fzf</a> is a command-line fuzzy finder. It’s packaged with scripts to add <a href="https://github.com/junegunn/fzf#key-bindings-for-command-line">keybindings</a> and <a href="https://github.com/junegunn/fzf#fuzzy-completion-for-bash-and-zsh">fuzzy completion</a> to your shell. To use them in bash you can source them in your <code>~/.bashrc</code>.</p>
<p><a href="https://github.com/junegunn/fzf/blob/0030d184481686384676537857614977e1fd2f94/shell/completion.bash">Bash fuzzy completion</a> can be triggered with <code>**&lt;TAB&gt;</code>. The script first saves existing completion specifications (e.g. functions defined by the <a href="https://github.com/scop/bash-completion">bash-completion</a> package). Then, it replaces the original specifications with new ones using the <a href="https://www.gnu.org/software/bash/manual/html_node/Programmable-Completion-Builtins.html">complete</a> builtin (e.g. <code>complete -F _fzf_path_completion cd</code>).</p>
<p>The script only supports a few commands by default. Thus, other commands need to be added <a href="https://github.com/junegunn/fzf#supported-commands">manually</a> using <code>complete</code>.</p>
<h1 data-number="2" id="fuzzy-path-completion-2019-06-02"><span class="header-section-number">2</span> Fuzzy path completion (2019-06-02)</h1>
<p>I wanted fuzzy path completion for every command while keeping the ability to call the default bash completion, so I wrote my own script.</p>
<p>I couldn’t use <code>complete</code> since we saw it forces us to write a specification for each command. So, I couldn’t access the <a href="https://www.gnu.org/software/bash/manual/html_node/Bash-Variables.html#index-COMP_005fCWORD"><code>COMP_*</code></a> shell variables inside my script anymore. Keybindings in bash are created using the <a href="https://www.gnu.org/software/bash/manual/html_node/Bash-Builtins.html#index-bind">bind</a> builtin. We can bind our own shell command using <code>bind -x '"keyseq": "shell-command"'</code>. Binding a shell function this way gives us access to the <code>READLINE_LINE</code> and <code>READLINE_POINT</code> variables inside it, allowing us to access the line currently typed in the shell without using the <code>COMP_*</code> variables.</p>
<blockquote>
<pre><code>READLINE_LINE
    The contents of the readline line buffer, for use with &quot;bind -x&quot;
    (see SHELL BUILTIN COMMANDS below).

READLINE_POINT
    The position of the insertion point in the readline line buffer,
    for use with &quot;bind -x&quot; (see SHELL BUILTIN COMMANDS below).</code></pre>
<a href="https://www.gnu.org/software/bash/manual/html_node/Bash-Variables.html#index-READLINE_005fLINE">Bash Reference manual - Shell Variables</a>
</blockquote>
<p>I also needed to find a way to call readline’s completion without having to manually call a specific completion function. To do this we can bind the <a href="https://www.gnu.org/software/bash/manual/html_node/Commands-For-Completion.html#index-complete-_0028TAB_0029">complete readline function</a> to the <code>\e[0n</code> key sequence (VT100 ANSI escape sequence for <code>Response: terminal is OK</code>). Then we print <code>\e[5n</code> (VT100 ANSI escape sequence for <code>Device status report</code>). The terminal then answers with <code>\e[0n</code>, which in turns activates readline’s completion. <a href="https://unix.stackexchange.com/a/217390">[1]</a></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Minimal fuzzy completion on trigger sequence &#39;@&#39;, else use readline&#39;s</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co"># completion.</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="fu">_fzf_complete()</span> <span class="kw">{</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>    <span class="bu">local</span> <span class="va">words=(</span> <span class="va">${READLINE_LINE:0:$READLINE_POINT}</span> <span class="va">)</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>    <span class="bu">local</span> <span class="va">remainder=(</span> <span class="va">${READLINE_LINE:$READLINE_POINT}</span> <span class="va">)</span></span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="kw">if [[</span> <span class="st">&quot;</span><span class="va">${words[-1]:0:1}</span><span class="st">&quot;</span> <span class="ot">!=</span> <span class="st">&#39;@&#39;</span><span class="kw"> ]]</span>; <span class="kw">then</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>        <span class="bu">bind</span> <span class="st">&#39;&quot;\e[0n&quot;: complete&#39;</span><span class="kw">;</span> <span class="bu">printf</span> <span class="st">&#39;\e[5n&#39;</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>        <span class="bu">return</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>    <span class="kw">fi</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>    <span class="bu">unset</span> <span class="st">&#39;words[-1]&#39;</span></span>
<span id="cb2-12"><a href="#cb2-12"></a></span>
<span id="cb2-13"><a href="#cb2-13"></a>    <span class="bu">local</span> <span class="va">selected=$(</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>        <span class="ex">fd</span> . --print0 \</span>
<span id="cb2-15"><a href="#cb2-15"></a>        <span class="kw">|</span> <span class="ex">fzf</span> --reverse --multi --read0 --print0 --exit-0 \</span>
<span id="cb2-16"><a href="#cb2-16"></a>        <span class="kw">|</span> <span class="fu">xargs</span> -0 --no-run-if-empty printf <span class="st">&#39;%q &#39;</span></span>
<span id="cb2-17"><a href="#cb2-17"></a>    <span class="va">)</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>    [[ <span class="ex">-z</span> <span class="st">&quot;</span><span class="va">$selected</span><span class="st">&quot;</span> ]] <span class="kw">&amp;&amp;</span> <span class="bu">return</span></span>
<span id="cb2-19"><a href="#cb2-19"></a></span>
<span id="cb2-20"><a href="#cb2-20"></a>    <span class="va">READLINE_LINE=</span><span class="st">&quot;</span><span class="va">${words[*]}</span><span class="st"> </span><span class="va">${selected}${remainder[*]}</span><span class="st">&quot;</span></span>
<span id="cb2-21"><a href="#cb2-21"></a>    <span class="va">READLINE_POINT=$((</span> <span class="va">$READLINE_POINT</span> + <span class="va">${#selected}</span> <span class="va">))</span></span>
<span id="cb2-22"><a href="#cb2-22"></a><span class="kw">}</span></span>
<span id="cb2-23"><a href="#cb2-23"></a></span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="co"># bind _fzf_complete to &lt;TAB&gt;</span></span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="bu">bind</span> -x <span class="st">&#39;&quot;\C-i&quot;: &quot;_fzf_complete&quot;&#39;</span></span></code></pre></div>
<h1 data-number="3" id="fuzzy-path-selection-on-keybinding-2019-07-23"><span class="header-section-number">3</span> Fuzzy path selection on keybinding (2019-07-23)</h1>
<p>After a few weeks of using the script in the previous section, I decided to simplify it by calling fzf with a keybinding instead of calling it on tab completion. The easiest solution would have been to <code>source /usr/share/fzf/key-bindings.bash</code> but I wasn’t satisfied with the defaults and rewrote it.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">_fzf_select()</span> <span class="kw">{</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>    <span class="bu">local</span> <span class="va">lineleft=${READLINE_LINE:0:$READLINE_POINT}</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>    <span class="bu">local</span> <span class="va">lineright=${READLINE_LINE:$READLINE_POINT}</span></span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a>    <span class="co"># 1. retrieve recursive list of files and directories (by default fzf only</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>    <span class="co">#    search through files)</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>    <span class="co"># 2. run fzf w/ multi-select enabled</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>    <span class="co"># 3. quote the results in a way that can be reused as shell input</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>    <span class="bu">local</span> <span class="va">selected=$(</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>        <span class="ex">fd</span> . --print0 \</span>
<span id="cb3-11"><a href="#cb3-11"></a>        <span class="kw">|</span> <span class="ex">fzf</span> --reverse --multi --read0 --print0 --exit-0 \</span>
<span id="cb3-12"><a href="#cb3-12"></a>        <span class="kw">|</span> <span class="fu">xargs</span> -0 --no-run-if-empty printf <span class="st">&#39;%q &#39;</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>    <span class="va">)</span></span>
<span id="cb3-14"><a href="#cb3-14"></a>    [[ <span class="ex">-z</span> <span class="st">&quot;</span><span class="va">$selected</span><span class="st">&quot;</span> ]] <span class="kw">&amp;&amp;</span> <span class="bu">return</span></span>
<span id="cb3-15"><a href="#cb3-15"></a></span>
<span id="cb3-16"><a href="#cb3-16"></a>    <span class="va">READLINE_LINE=</span><span class="st">&quot;</span><span class="va">${lineleft}${selected}${lineright}</span><span class="st">&quot;</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>    <span class="va">READLINE_POINT=$((</span> <span class="va">$READLINE_POINT</span> + <span class="va">${#selected}</span> <span class="va">))</span></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="kw">}</span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="co"># bind _fzf_select to CTRL+F</span></span>
<span id="cb3-20"><a href="#cb3-20"></a><span class="bu">bind</span> -x <span class="st">&#39;&quot;\C-f&quot;: &quot;_fzf_select&quot;&#39;</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb4-1"><a href="#cb4-1"></a>$ cat &lt;CTRL+F&gt;</span>
<span id="cb4-2"><a href="#cb4-2"></a>&gt; exp .sh</span>
<span id="cb4-3"><a href="#cb4-3"></a>  720/23328 (2)</span>
<span id="cb4-4"><a href="#cb4-4"></a> &gt;Documents/CompSci/Experiments/Shell/scope.sh</span>
<span id="cb4-5"><a href="#cb4-5"></a>  Documents/CompSci/Experiments/Shell/heredoc.sh</span>
<span id="cb4-6"><a href="#cb4-6"></a>  Documents/CompSci/Experiments/progress/run.sh</span>
<span id="cb4-7"><a href="#cb4-7"></a>  Documents/CompSci/Experiments/progress/pv/run.sh</span>
<span id="cb4-8"><a href="#cb4-8"></a>  Documents/CompSci/Experiments/progress/tqdmpy/run.sh</span>
<span id="cb4-9"><a href="#cb4-9"></a>  Documents/CompSci/Experiments/progress/tqdmlua/run.sh</span>
<span id="cb4-10"><a href="#cb4-10"></a>  Documents/CompSci/Experiments/progress/tqdmcpp/run.sh</span>
<span id="cb4-11"><a href="#cb4-11"></a> &gt;Documents/CompSci/Experiments/virtualization/gitlabci/run.sh</span>
<span id="cb4-12"><a href="#cb4-12"></a>  Documents/CompSci/Experiments/Shell/readline-input-injection/completion.sh</span>
<span id="cb4-13"><a href="#cb4-13"></a>$ cat Documents/CompSci/Experiments/Shell/scope.sh Documents/CompSci/Experiments/virtualization/gitlabci/run.sh</span></code></pre></div>

</article>

</main>
</body>

</html>
